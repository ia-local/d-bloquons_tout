<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©veloppement de la Pr√©sentation</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Projet de Loi üìú</h1>
        <h2>R√©forme du Code du Travail</h2>
        <nav>
            <a href="/home" class="nav-link">Accueil</a>
            <a href="/index" class="nav-link">G√©n√©rateur</a>
            <a href="/developpement" class="nav-link active">D√©veloppement</a>
            <a href="/save" class="nav-link">Sauvegardes</a>
        </nav>
    </header>

    <main class="main-container">
        <aside class="sidebar">
            <h3>Travaux en cours</h3>
            <ul class="nav-menu">
                <li class="nav-item" data-option="detailed_development_plan"><i class="fas fa-tasks"></i> Plan de D√©veloppement</li>
                <li class="nav-item" data-option="etude-impact-economique"><i class="fas fa-chart-pie"></i> √âtude d'Impact √âconomique</li>
            </ul>
        </aside>
        <section class="content-container">
            <section id="content">
                <div class="loader-container">
                    <div class="loader"></div>
                    <p>Cliquez sur un √©l√©ment du menu pour g√©n√©rer une √©bauche de pr√©sentation pour l'√©tude...</p>
                </div>
            </section>
            <div class="save-controls">
                <button id="save-button" style="display: none;">Enregistrer la pr√©sentation</button>
                <div id="status-message"></div>
            </div>
        </section>
    </main>
    
    <footer>
        <p>&copy; 2025 - R√©forme du Code du Travail</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contentSection = document.getElementById('content');
            const navItems = document.querySelectorAll('.nav-item');
            const saveButton = document.getElementById('save-button');
            const statusMessage = document.getElementById('status-message');

            let currentContentType = '';

            // Fonction pour cr√©er les graphiques √† partir des donn√©es JSON
            const createCharts = (chartData) => {
                if (!chartData) return;

                // Graphique de la valeur du CVNU (ligne)
                const cvnuCtx = document.getElementById('cvnuValueChart');
                if (cvnuCtx && chartData.cvnu) {
                    new Chart(cvnuCtx, {
                        type: 'line',
                        data: {
                            labels: chartData.cvnu.data.labels,
                            datasets: [{
                                label: 'Valeur du CVNU (‚Ç¨)',
                                data: chartData.cvnu.data.datasets[0].data,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        }
                    });
                }

                // Graphique de la r√©duction de la pauvret√© (barres)
                const povertyCtx = document.getElementById('povertyReductionChart');
                if (povertyCtx && chartData.pauvrete) {
                    new Chart(povertyCtx, {
                        type: 'bar',
                        data: {
                            labels: chartData.pauvrete.data.labels,
                            datasets: [{
                                label: 'R√©duction de la Pauvret√© (%)',
                                data: chartData.pauvrete.data.datasets[0].data,
                                backgroundColor: 'rgba(255, 99, 132, 0.5)'
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            };


            const fetchContent = async (audience) => {
                let url;
                if (audience === 'detailed_development_plan') {
                    url = '/generate-law-content?audience=detailed_development_plan';
                } else if (audience === 'etude-impact-economique') {
                    url = '/generate/etude-impact-economique';
                }

                if (!url) {
                    contentSection.innerHTML = '<p class="error">S√©lectionnez une option valide.</p>';
                    return;
                }
                
                contentSection.innerHTML = `<div class="loader-container"><div class="loader"></div><p>G√©n√©ration de la pr√©sentation en cours...</p></div>`;
                saveButton.style.display = 'none';
                statusMessage.textContent = '';
                currentContentType = audience;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    const data = await response.text();

                    // Cr√©ation d'un conteneur temporaire pour manipuler le HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;

                    // Trouver la balise de script JSON
                    const jsonScriptTag = tempDiv.querySelector('script[type="application/json"]');
                    let chartData = null;
                    if (jsonScriptTag) {
                        try {
                            chartData = JSON.parse(jsonScriptTag.textContent);
                            jsonScriptTag.remove(); // Retirer le script pour ne pas l'injecter dans le DOM
                        } catch (e) {
                            console.error("Erreur de parsing JSON :", e);
                        }
                    }

                    // Injecter le reste du HTML
                    contentSection.innerHTML = tempDiv.innerHTML;
                    
                    // Cr√©er les graphiques si des donn√©es sont pr√©sentes
                    if (chartData) {
                        createCharts(chartData);
                    }
                    
                    saveButton.style.display = 'block';

                } catch (error) {
                    console.error('Erreur lors de la r√©cup√©ration du contenu:', error);
                    contentSection.innerHTML = '<p class="error">D√©sol√©, une erreur est survenue lors du chargement du contenu.</p>';
                    saveButton.style.display = 'none';
                }
            };

            const saveContent = async () => {
                const content = contentSection.innerHTML;
                const type = currentContentType;
                statusMessage.textContent = 'Enregistrement en cours...';

                try {
                    const response = await fetch('/save-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content, type }),
                    });

                    const result = await response.json();
                    if (response.ok) {
                        statusMessage.textContent = result.message;
                        statusMessage.style.color = 'green';
                    } else {
                        statusMessage.textContent = result.message;
                        statusMessage.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde :', error);
                    statusMessage.textContent = 'Erreur lors de la sauvegarde.';
                    statusMessage.style.color = 'red';
                }
            };

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const selectedOption = item.dataset.option;
                    if (selectedOption) {
                        fetchContent(selectedOption);
                    }
                });
            });

            saveButton.addEventListener('click', saveContent);
        });
    </script>
</body>
</html>